<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - FitSync</title>
    <link rel="stylesheet" href="../css/style.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <header>
        <nav class="container">
            <div class="logo">FitSync</div>
            <ul class="nav-links">
                <li><a href="/">Home</a></li>
                <li><a href="/about/">About</a></li>
                <li><a href="/#features">Features</a></li>
                <li><a href="/contact/">Contact</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <section class="hero reset-hero">
            <div class="container">
                <div class="reset-container">
                    
                    <!-- Loading State -->
                    <div id="loading" class="reset-card">
                        <div class="status-icon">‚è≥</div>
                        <h1>Validating Reset Link</h1>
                        <p>Please wait while we verify your password reset request...</p>
                    </div>
                    
                    <!-- Password Reset Form -->
                    <div id="reset-form" class="reset-card hidden">
                        <div class="status-icon">üîí</div>
                        <h1>Reset Your Password</h1>
                        <p>Enter your new password below to secure your FitSync account.</p>
                        
                        <form id="passwordForm" class="password-form">
                            <div class="form-group">
                                <label for="newPassword">New Password</label>
                                <input 
                                    type="password" 
                                    id="newPassword" 
                                    name="newPassword"
                                    class="form-input" 
                                    placeholder="Enter new password"
                                    minlength="6"
                                    required
                                />
                            </div>
                            
                            <div class="form-group">
                                <label for="confirmPassword">Confirm New Password</label>
                                <input 
                                    type="password" 
                                    id="confirmPassword" 
                                    name="confirmPassword"
                                    class="form-input" 
                                    placeholder="Confirm new password"
                                    minlength="6"
                                    required
                                />
                            </div>
                            
                            <button type="submit" id="resetButton" class="cta-button primary full-width">
                                Reset Password
                            </button>
                        </form>
                        
                        <div id="message" class="message"></div>
                        
                        <div class="form-footer">
                            <a href="fitsync://auth/login" class="deep-link-button">
                                Return to FitSync App
                            </a>
                        </div>
                    </div>
                    
                    <!-- Error State -->
                    <div id="error-state" class="reset-card hidden">
                        <div class="status-icon error">‚ùå</div>
                        <h1>Invalid Reset Link</h1>
                        <p class="error-text">This password reset link is invalid or has expired. Please request a new password reset from the FitSync app.</p>
                        <div class="form-footer">
                            <a href="fitsync://auth/login" class="deep-link-button">
                                Open FitSync App
                            </a>
                        </div>
                    </div>
                    
                    <!-- Success State -->
                    <div id="success-state" class="reset-card hidden">
                        <div class="status-icon success">‚úÖ</div>
                        <h1>Password Reset Successfully!</h1>
                        <p class="success-text">Your password has been updated. You can now log in to FitSync with your new password.</p>
                        <p class="redirect-text">Redirecting to FitSync app...</p>
                        <div class="form-footer">
                            <a href="fitsync://auth/password-reset-success" class="cta-button primary">
                                Continue to FitSync
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="reset-info">
            <div class="container">
                <div class="info-grid">
                    <div class="info-item">
                        <h3>üîê Secure Process</h3>
                        <p>Your password reset is handled securely through encrypted connections and validated tokens.</p>
                    </div>
                    <div class="info-item">
                        <h3>üì± Continue in App</h3>
                        <p>After resetting your password, you'll be redirected back to the FitSync app to continue your fitness journey.</p>
                    </div>
                    <div class="info-item">
                        <h3>üÜò Need Help?</h3>
                        <p>If you're having trouble resetting your password, contact our support team for assistance.</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <div class="download-section">
                <h3>Don't Have FitSync Yet?</h3>
                <div class="app-store-buttons">
                    <a href="#" class="store-button ios">üì± Download for iOS</a>
                    <a href="#" class="store-button android">ü§ñ Get it on Android</a>
                </div>
            </div>
            <p>&copy; 2024 FitSync. All rights reserved. The complete fitness ecosystem for serious athletes.</p>
        </div>
    </footer>

    <script src="../js/main.js"></script>
    <script>
        // Initialize Supabase client
        // Note: Supabase anon keys are safe to expose publicly - security is handled by RLS policies
        const supabase = window.supabase.createClient(
            'https://rdwcftfxnfcatmjapfjn.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkd2NmdGZ4bmZjYXRtamFwZmpuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgxNDYwMTIsImV4cCI6MjA2MzcyMjAxMn0.R2dQtfnmJ6xzXPFYY815fg8wvZZtjSlSkOeXBYtJ8kA'
        );
        
        let isValidSession = false;
        
        // Show different UI states
        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('reset-form').classList.add('hidden');
            document.getElementById('error-state').classList.add('hidden');
            document.getElementById('success-state').classList.add('hidden');
        }
        
        function showResetForm() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('reset-form').classList.remove('hidden');
            document.getElementById('error-state').classList.add('hidden');
            document.getElementById('success-state').classList.add('hidden');
            
            // Focus on first input
            setTimeout(() => {
                document.getElementById('newPassword').focus();
            }, 100);
        }
        
        function showError() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('reset-form').classList.add('hidden');
            document.getElementById('error-state').classList.remove('hidden');
            document.getElementById('success-state').classList.add('hidden');
        }
        
        function showSuccess() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('reset-form').classList.add('hidden');
            document.getElementById('error-state').classList.add('hidden');
            document.getElementById('success-state').classList.remove('hidden');
        }
        
        // Enhanced token extraction function
        function extractTokensFromUrl() {
            console.log('üîç Full URL:', window.location.href);
            console.log('üîç Hash:', window.location.hash);
            console.log('üîç Search:', window.location.search);
            
            const url = new URL(window.location.href);
            let tokens = {};
            
            // Method 1: Hash fragments (most common)
            if (url.hash) {
                console.log('üìç Parsing from hash fragments');
                const hashParams = new URLSearchParams(url.hash.substring(1));
                tokens = {
                    access_token: hashParams.get('access_token'),
                    refresh_token: hashParams.get('refresh_token'),
                    type: hashParams.get('type'),
                    error: hashParams.get('error'),
                    error_description: hashParams.get('error_description'),
                    expires_at: hashParams.get('expires_at')
                };
            }
            
            // Method 2: Query parameters
            else if (url.search) {
                console.log('üìç Parsing from query parameters');
                tokens = {
                    access_token: url.searchParams.get('access_token'),
                    refresh_token: url.searchParams.get('refresh_token'),
                    type: url.searchParams.get('type'),
                    error: url.searchParams.get('error'),
                    error_description: url.searchParams.get('error_description'),
                    token: url.searchParams.get('token'), // Legacy format
                    expires_at: url.searchParams.get('expires_at')
                };
            }
            
            // Method 3: Handle legacy token-only format
            if (!tokens.access_token && tokens.token) {
                console.log('üìç Using legacy token format');
                tokens.access_token = tokens.token;
                tokens.type = 'recovery';
            }
            
            return tokens;
        }

        // Handle password reset tokens
        async function handleResetToken() {
            try {
                const tokens = extractTokensFromUrl();
                
                console.log('üîç Extracted tokens:', { 
                    type: tokens.type, 
                    hasAccessToken: !!tokens.access_token, 
                    hasRefreshToken: !!tokens.refresh_token,
                    error: tokens.error,
                    errorDescription: tokens.error_description,
                    accessTokenLength: tokens.access_token?.length,
                    refreshTokenLength: tokens.refresh_token?.length,
                    hasLegacyToken: !!tokens.token,
                    expiresAt: tokens.expires_at
                });
                
                // Check for error in URL
                if (tokens.error) {
                    console.error('‚ùå URL contains error:', tokens.error, tokens.error_description);
                    showError();
                    return;
                }
                
                // Check for required tokens - try multiple formats
                const hasValidTokens = (
                    (tokens.type === 'recovery' && tokens.access_token && tokens.refresh_token) || // Standard format
                    (tokens.access_token && tokens.type === 'recovery') || // Minimal format
                    (tokens.token && !tokens.type) // Legacy format
                );
                
                if (hasValidTokens) {
                    console.log('‚úÖ Valid recovery tokens found, setting session...');
                    
                    const sessionData = {
                        access_token: tokens.access_token,
                        refresh_token: tokens.refresh_token || tokens.access_token // Fallback for legacy
                    };
                    
                    const { data, error: sessionError } = await supabase.auth.setSession(sessionData);
                    
                    if (sessionError) {
                        console.error('‚ùå Session error:', sessionError);
                        console.error('Error details:', {
                            message: sessionError.message,
                            status: sessionError.status,
                            statusCode: sessionError.statusCode,
                            name: sessionError.name
                        });
                        
                        // Try alternative session methods if main one fails
                        console.log('üîÑ Trying alternative authentication...');
                        
                        // For legacy token format, try signInWithOtp
                        if (tokens.token && !tokens.refresh_token) {
                            console.log('üîÑ Attempting token-based recovery...');
                            // This might work for some Supabase configurations
                            isValidSession = true;
                            showResetForm();
                            return;
                        }
                        
                        showError();
                    } else {
                        console.log('‚úÖ Session set successfully:', data);
                        isValidSession = true;
                        showResetForm();
                    }
                } else {
                    console.log('‚ùå Invalid or missing tokens:', {
                        hasType: !!tokens.type,
                        typeValue: tokens.type,
                        typeMatch: tokens.type === 'recovery',
                        hasAccessToken: !!tokens.access_token,
                        hasRefreshToken: !!tokens.refresh_token,
                        hasLegacyToken: !!tokens.token,
                        allTokens: tokens
                    });
                    showError();
                }
            } catch (error) {
                console.error('üí• Exception handling reset token:', error);
                showError();
            }
        }
        
        // Show message helper
        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = `message ${type}`;
        }
        
        // Password validation
        function validatePasswords() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!newPassword || !confirmPassword) {
                showMessage('Please fill in both password fields.', 'error');
                return false;
            }
            
            if (newPassword !== confirmPassword) {
                showMessage('Passwords do not match.', 'error');
                return false;
            }
            
            if (newPassword.length < 6) {
                showMessage('Password must be at least 6 characters long.', 'error');
                return false;
            }
            
            // Clear any previous error messages
            showMessage('', '');
            return true;
        }
        
        // Handle form submission
        document.getElementById('passwordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!isValidSession) {
                showMessage('Invalid session. Please use the link from your email.', 'error');
                return;
            }
            
            if (!validatePasswords()) {
                return;
            }
            
            const newPassword = document.getElementById('newPassword').value;
            const button = document.getElementById('resetButton');
            const originalText = button.textContent;
            
            // Show loading state
            button.disabled = true;
            button.textContent = 'Updating Password...';
            showMessage('', '');
            
            try {
                const { error } = await supabase.auth.updateUser({
                    password: newPassword
                });
                
                if (error) {
                    console.error('Password update error:', error);
                    showMessage(error.message || 'Failed to update password. Please try again.', 'error');
                    button.disabled = false;
                    button.textContent = originalText;
                } else {
                    showSuccess();
                    // Redirect to app after 3 seconds
                    setTimeout(() => {
                        window.location.href = 'fitsync://auth/password-reset-success';
                    }, 3000);
                }
            } catch (error) {
                console.error('Password reset error:', error);
                showMessage('An unexpected error occurred. Please try again.', 'error');
                button.disabled = false;
                button.textContent = originalText;
            }
        });
        
        // Real-time password validation
        document.getElementById('confirmPassword').addEventListener('input', function() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = this.value;
            
            if (confirmPassword && newPassword !== confirmPassword) {
                showMessage('Passwords do not match', 'warning');
            } else if (confirmPassword && newPassword === confirmPassword) {
                showMessage('Passwords match', 'success');
            }
        });
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            showLoading();
            
            // Add small delay to show loading state
            setTimeout(() => {
                handleResetToken();
            }, 500);
        });
        
        // Handle hash changes (for single-page navigation)
        window.addEventListener('hashchange', handleResetToken);
    </script>
</body>
</html>