<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - FitSync</title>
    <link rel="stylesheet" href="../css/style.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <header>
        <nav class="container">
            <div class="logo">FitSync</div>
            <ul class="nav-links">
                <li><a href="/">Home</a></li>
                <li><a href="/about/">About</a></li>
                <li><a href="/#features">Features</a></li>
                <li><a href="/faq/">FAQ</a></li>
                <li><a href="/contact/">Contact</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <section class="hero reset-hero">
            <div class="container">
                <div class="reset-container">
                    
                    <!-- Debug Information (hidden in production) -->
                    <div id="debug-panel" class="reset-card" style="background: #f8f9fa; border: 2px solid #007bff; margin-bottom: 20px; display: none;">
                        <div class="status-icon">üîç</div>
                        <h2>Debug Information</h2>
                        <div id="debug-content" style="font-family: monospace; font-size: 12px; text-align: left; max-height: 200px; overflow-y: auto; background: white; padding: 10px; border-radius: 4px;">
                            <strong>URL Analysis:</strong><br>
                        </div>
                    </div>

                    <!-- Loading State -->
                    <div id="loading" class="reset-card">
                        <div class="status-icon">‚è≥</div>
                        <h1>Validating Reset Link</h1>
                        <p>Please wait while we verify your password reset request...</p>
                    </div>
                    
                    <!-- Password Reset Form -->
                    <div id="reset-form" class="reset-card hidden">
                        <div class="status-icon">üîí</div>
                        <h1>Reset Your Password</h1>
                        <p>Enter your new password below to secure your FitSync account.</p>
                        
                        <form id="passwordForm" class="password-form">
                            <div class="form-group">
                                <label for="newPassword">New Password</label>
                                <input 
                                    type="password" 
                                    id="newPassword" 
                                    name="newPassword"
                                    class="form-input" 
                                    placeholder="Enter new password"
                                    minlength="6"
                                    required
                                />
                            </div>
                            
                            <div class="form-group">
                                <label for="confirmPassword">Confirm New Password</label>
                                <input 
                                    type="password" 
                                    id="confirmPassword" 
                                    name="confirmPassword"
                                    class="form-input" 
                                    placeholder="Confirm new password"
                                    minlength="6"
                                    required
                                />
                            </div>
                            
                            <button type="submit" id="resetButton" class="cta-button primary full-width">
                                Reset Password
                            </button>
                        </form>
                        
                        <div id="message" class="message"></div>
                        
                        <div class="form-footer">
                            <a href="fitsync://auth/login" class="deep-link-button">
                                Return to FitSync App
                            </a>
                        </div>
                    </div>
                    
                    <!-- Error State -->
                    <div id="error-state" class="reset-card hidden">
                        <div class="status-icon error">‚ùå</div>
                        <h1 id="error-title">Invalid Reset Link</h1>
                        <p id="error-message" class="error-text">This password reset link is invalid or has expired. Please request a new password reset from the FitSync app.</p>
                        <div class="form-footer">
                            <a href="fitsync://auth/login" class="deep-link-button">
                                Open FitSync App
                            </a>
                        </div>
                    </div>
                    
                    <!-- Success State -->
                    <div id="success-state" class="reset-card hidden">
                        <div class="status-icon success">‚úÖ</div>
                        <h1>Password Reset Successfully!</h1>
                        <p class="success-text">Your password has been updated. You can now log in to FitSync with your new password.</p>
                        <p class="redirect-text">Redirecting to FitSync app...</p>
                        <div class="form-footer">
                            <a href="fitsync://auth/password-reset-success" class="cta-button primary">
                                Continue to FitSync
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="reset-info">
            <div class="container">
                <div class="info-grid">
                    <div class="info-item">
                        <h3>üîê Secure Process</h3>
                        <p>Your password reset is handled securely through encrypted connections and validated tokens.</p>
                    </div>
                    <div class="info-item">
                        <h3>üì± Continue in App</h3>
                        <p>After resetting your password, you'll be redirected back to the FitSync app to continue your fitness journey.</p>
                    </div>
                    <div class="info-item">
                        <h3>üÜò Need Help?</h3>
                        <p>If you're having trouble resetting your password, contact our support team for assistance.</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <div class="download-section">
                <h3>Don't Have FitSync Yet?</h3>
                <div class="app-store-buttons">
                    <a href="#" class="store-button ios">üì± Download for iOS</a>
                    <a href="#" class="store-button android">ü§ñ Get it on Android</a>
                </div>
            </div>
            <p>&copy; 2024 FitSync. All rights reserved. The complete fitness ecosystem for serious athletes.</p>
        </div>
    </footer>

    <script src="../js/main.js"></script>
    <script>
        // Initialize Supabase client
        // Note: Supabase anon keys are safe to expose publicly - security is handled by RLS policies
        const supabase = window.supabase.createClient(
            'https://rdwcftfxnfcatmjapfjn.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkd2NmdGZ4bmZjYXRtamFwZmpuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgxNDYwMTIsImV4cCI6MjA2MzcyMjAxMn0.R2dQtfnmJ6xzXPFYY815fg8wvZZtjSlSkOeXBYtJ8kA'
        );
        
        let isValidSession = false;
        let capturedTokens = null; // Store tokens immediately to prevent loss
        
        // IMMEDIATE TOKEN CAPTURE - Do this first before anything else can clear the URL
        (function captureTokensImmediately() {
            const currentUrl = window.location.href;
            // Only log in development
            if (window.location.hostname === 'localhost') {
                console.log('üöÄ IMMEDIATE CAPTURE - Full URL:', currentUrl);
            }
            
            if (currentUrl.includes('#')) {
                const hashPart = window.location.hash.substring(1);
                if (window.location.hostname === 'localhost') {
                    console.log('üöÄ IMMEDIATE CAPTURE - Hash part:', hashPart);
                }
                
                if (hashPart && hashPart.includes('access_token')) {
                    const hashParams = new URLSearchParams(hashPart);
                    capturedTokens = {
                        access_token: hashParams.get('access_token'),
                        refresh_token: hashParams.get('refresh_token'),
                        type: hashParams.get('type'),
                        expires_at: hashParams.get('expires_at'),
                        error: hashParams.get('error'),
                        error_description: hashParams.get('error_description'),
                        captured_at: new Date().toISOString()
                    };
                    if (window.location.hostname === 'localhost') {
                        console.log('‚úÖ IMMEDIATE CAPTURE - Tokens stored:', {
                            hasAccessToken: !!capturedTokens.access_token,
                            type: capturedTokens.type,
                            accessTokenLength: capturedTokens.access_token?.length
                        });
                    }
                }
            }
        })();
        
        // Debug logging function (disabled in production)
        function debugLog(message) {
            // Only log to console in development (when debug panel is visible or localhost)
            if (window.location.hostname === 'localhost' || document.getElementById('debug-panel')?.style.display !== 'none') {
                console.log(message);
                const debugContent = document.getElementById('debug-content');
                if (debugContent) {
                    debugContent.innerHTML += message + '<br>';
                }
            }
        }
        
        // Show different UI states
        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('reset-form').classList.add('hidden');
            document.getElementById('error-state').classList.add('hidden');
            document.getElementById('success-state').classList.add('hidden');
        }
        
        function showResetForm() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('reset-form').classList.remove('hidden');
            document.getElementById('error-state').classList.add('hidden');
            document.getElementById('success-state').classList.add('hidden');
            
            // Focus on first input
            setTimeout(() => {
                document.getElementById('newPassword').focus();
            }, 100);
        }
        
        function showError() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('reset-form').classList.add('hidden');
            document.getElementById('error-state').classList.remove('hidden');
            document.getElementById('success-state').classList.add('hidden');
        }
        
        function showSuccess() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('reset-form').classList.add('hidden');
            document.getElementById('error-state').classList.add('hidden');
            document.getElementById('success-state').classList.remove('hidden');
        }
        
        // Enhanced token extraction - handles multiple Supabase formats
        function extractTokensFromUrl() {
            const url = new URL(window.location.href);
            
            debugLog('üîç Full URL: ' + window.location.href);
            debugLog('üîç Hash: ' + window.location.hash);
            debugLog('üîç Search: ' + window.location.search);
            
            let tokens = {};
            
            // Method 0: Use captured tokens if available (highest priority)
            if (capturedTokens) {
                debugLog('üìç Using immediately captured tokens');
                tokens = { ...capturedTokens };
                debugLog('‚úÖ Captured tokens: ' + JSON.stringify({
                    hasAccessToken: !!tokens.access_token,
                    type: tokens.type,
                    capturedAt: tokens.captured_at
                }));
            }
            // Method 1: Hash fragments (after Supabase redirect)
            else if (url.hash) {
                debugLog('üìç Parsing from hash fragments');
                const hashParams = new URLSearchParams(url.hash.substring(1));
                tokens = {
                    access_token: hashParams.get('access_token'),
                    refresh_token: hashParams.get('refresh_token'),
                    type: hashParams.get('type'),
                    error: hashParams.get('error'),
                    error_description: hashParams.get('error_description'),
                    expires_at: hashParams.get('expires_at')
                };
            }
            
            // Method 2: Query parameters (backup or direct token)
            if (url.search) {
                debugLog('üìç Parsing from query parameters');
                const searchParams = url.searchParams;
                const queryTokens = {
                    access_token: searchParams.get('access_token'),
                    refresh_token: searchParams.get('refresh_token'),
                    type: searchParams.get('type'),
                    error: searchParams.get('error'),
                    error_description: searchParams.get('error_description'),
                    expires_at: searchParams.get('expires_at'),
                    // Also check for direct Supabase token format
                    token: searchParams.get('token')
                };
                
                // If we don't have tokens from hash, use query params
                if (!tokens.access_token) {
                    tokens = queryTokens;
                }
            }
            
            // Method 3: Handle direct Supabase token format (bypass redirect)
            if (!tokens.access_token && tokens.token && tokens.type === 'recovery') {
                debugLog('üìç Found direct Supabase token - attempting direct verification');
                tokens.access_token = tokens.token; // Use token as access_token
                tokens.direct_token = true; // Flag for special handling
            }
            
            debugLog('üîç Extracted tokens: ' + JSON.stringify({
                hasAccessToken: !!tokens.access_token,
                hasRefreshToken: !!tokens.refresh_token,
                hasDirectToken: !!tokens.direct_token,
                type: tokens.type,
                error: tokens.error,
                accessTokenLength: tokens.access_token?.length,
                refreshTokenLength: tokens.refresh_token?.length
            }));
            
            return tokens;
        }

        // Handle password reset tokens  
        async function handleResetToken() {
            try {
                const tokens = extractTokensFromUrl();
                
                // Check for error in URL first
                if (tokens.error) {
                    debugLog('‚ùå URL contains error: ' + tokens.error + ' - ' + tokens.error_description);
                    
                    // Customize error message based on error type
                    const errorTitle = document.getElementById('error-title');
                    const errorMessage = document.getElementById('error-message');
                    
                    if (tokens.error === 'access_denied' && tokens.error_description?.includes('expired')) {
                        errorTitle.textContent = 'Reset Link Expired';
                        errorMessage.textContent = 'This password reset link has expired. Password reset links are only valid for 1 hour. Please request a new password reset from the FitSync app.';
                    } else if (tokens.error === 'access_denied') {
                        errorTitle.textContent = 'Access Denied';
                        errorMessage.textContent = 'This password reset link has been denied access. Please request a new password reset from the FitSync app.';
                    } else {
                        errorTitle.textContent = 'Reset Link Error';
                        errorMessage.textContent = 'There was an error with this password reset link: ' + (tokens.error_description || tokens.error) + '. Please request a new password reset from the FitSync app.';
                    }
                    
                    showError();
                    return;
                }
                
                // Check if we have valid recovery tokens
                if (tokens.type === 'recovery' && tokens.access_token) {
                    debugLog('‚úÖ Valid recovery tokens found, setting session...');
                    
                    // Handle direct token case (bypass Supabase redirect)
                    if (tokens.direct_token) {
                        debugLog('üîÑ Using direct token method...');
                        
                        // For direct tokens, we need to verify via Supabase API
                        try {
                            const { data, error: verifyError } = await supabase.auth.verifyOtp({
                                token_hash: tokens.access_token,
                                type: 'recovery'
                            });
                            
                            if (verifyError) {
                                debugLog('‚ùå Direct token verification error: ' + verifyError.message);
                                showError();
                                return;
                            } else {
                                debugLog('‚úÖ Direct token verified successfully!');
                                debugLog('User: ' + (data.user ? data.user.email : 'No user data'));
                                isValidSession = true;
                                showResetForm();
                                return;
                            }
                        } catch (directError) {
                            debugLog('‚ùå Exception in direct token verification: ' + directError.message);
                            // Fall through to standard session method
                        }
                    }
                    
                    // Standard session method
                    const sessionData = {
                        access_token: tokens.access_token,
                        refresh_token: tokens.refresh_token || tokens.access_token // Use access_token as fallback
                    };
                    
                    debugLog('üîÑ Calling supabase.auth.setSession...');
                    const { data, error: sessionError } = await supabase.auth.setSession(sessionData);
                    
                    if (sessionError) {
                        debugLog('‚ùå Session error: ' + sessionError.message);
                        debugLog('Error details: ' + JSON.stringify({
                            message: sessionError.message,
                            status: sessionError.status,
                            statusCode: sessionError.statusCode,
                            name: sessionError.name
                        }));
                        showError();
                    } else {
                        debugLog('‚úÖ Session set successfully!');
                        debugLog('User: ' + (data.user ? data.user.email : 'No user data'));
                        isValidSession = true;
                        showResetForm();
                    }
                } else {
                    debugLog('‚ùå Invalid or missing tokens. Required: type=recovery and access_token');
                    debugLog('Current: type=' + tokens.type + ', hasAccessToken=' + !!tokens.access_token);
                    
                    // If no tokens at all, this might be the initial page load
                    if (!tokens.access_token && !tokens.error && !window.location.hash && !window.location.search) {
                        debugLog('üìù No tokens found - this appears to be direct page access');
                        debugLog('Expected flow: Email link ‚Üí Supabase verification ‚Üí Redirect here with tokens');
                    }
                    
                    showError();
                }
            } catch (error) {
                debugLog('üí• Exception in handleResetToken: ' + error.message);
                console.error('Exception details:', error);
                showError();
            }
        }
        
        // Show message helper
        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = `message ${type}`;
        }
        
        // Password validation
        function validatePasswords() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!newPassword || !confirmPassword) {
                showMessage('Please fill in both password fields.', 'error');
                return false;
            }
            
            if (newPassword !== confirmPassword) {
                showMessage('Passwords do not match.', 'error');
                return false;
            }
            
            if (newPassword.length < 6) {
                showMessage('Password must be at least 6 characters long.', 'error');
                return false;
            }
            
            // Clear any previous error messages
            showMessage('', '');
            return true;
        }
        
        // Handle form submission
        document.getElementById('passwordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!isValidSession) {
                showMessage('Invalid session. Please use the link from your email.', 'error');
                return;
            }
            
            if (!validatePasswords()) {
                return;
            }
            
            const newPassword = document.getElementById('newPassword').value;
            const button = document.getElementById('resetButton');
            const originalText = button.textContent;
            
            // Show loading state
            button.disabled = true;
            button.textContent = 'Updating Password...';
            showMessage('', '');
            
            try {
                const { error } = await supabase.auth.updateUser({
                    password: newPassword
                });
                
                if (error) {
                    console.error('Password update error:', error);
                    showMessage(error.message || 'Failed to update password. Please try again.', 'error');
                    button.disabled = false;
                    button.textContent = originalText;
                } else {
                    showSuccess();
                    // Redirect to app after 3 seconds
                    setTimeout(() => {
                        window.location.href = 'fitsync://auth/password-reset-success';
                    }, 3000);
                }
            } catch (error) {
                console.error('Password reset error:', error);
                showMessage('An unexpected error occurred. Please try again.', 'error');
                button.disabled = false;
                button.textContent = originalText;
            }
        });
        
        // Real-time password validation
        document.getElementById('confirmPassword').addEventListener('input', function() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = this.value;
            
            if (confirmPassword && newPassword !== confirmPassword) {
                showMessage('Passwords do not match', 'warning');
            } else if (confirmPassword && newPassword === confirmPassword) {
                showMessage('Passwords match', 'success');
            }
        });
        
        // Check if this is a direct Supabase link that needs special handling
        function checkForDirectSupabaseLink() {
            const url = window.location.href;
            const referrer = document.referrer;
            
            debugLog('üîç Current URL: ' + url);
            debugLog('üîç Referrer: ' + referrer);
            
            // Check if we came from a Supabase verification (referrer contains supabase.co)
            if (referrer && referrer.includes('supabase.co')) {
                debugLog('üìç Came from Supabase verification - checking for token in referrer...');
                
                try {
                    const referrerUrl = new URL(referrer);
                    const token = referrerUrl.searchParams.get('token');
                    const type = referrerUrl.searchParams.get('type');
                    
                    if (token && type === 'recovery') {
                        debugLog('‚úÖ Found token in referrer - adding to current URL');
                        const currentUrl = new URL(window.location.href);
                        currentUrl.searchParams.set('token', token);
                        currentUrl.searchParams.set('type', type);
                        
                        // Replace current history entry to avoid back button issues
                        window.history.replaceState({}, '', currentUrl.toString());
                        debugLog('üìç Updated URL with tokens: ' + currentUrl.toString());
                        return false; // Continue processing with updated URL
                    }
                } catch (error) {
                    debugLog('‚ùå Error parsing referrer URL: ' + error.message);
                }
            }
            
            // If this looks like a Supabase verification URL, extract and redirect
            if (url.includes('/auth/v1/verify') || url.includes('supabase.co')) {
                debugLog('üîÑ Detected Supabase verification URL - extracting token...');
                
                const urlObj = new URL(url);
                const token = urlObj.searchParams.get('token');
                const type = urlObj.searchParams.get('type');
                const redirectTo = urlObj.searchParams.get('redirect_to');
                
                if (token && type === 'recovery' && redirectTo) {
                    debugLog('üìç Redirecting with token parameters...');
                    const targetUrl = redirectTo + '?token=' + token + '&type=' + type;
                    window.location.href = targetUrl;
                    return true; // Indicates we're redirecting
                }
            }
            
            return false; // No redirect needed
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            showLoading();
            
            // Check for direct Supabase link first
            if (checkForDirectSupabaseLink()) {
                debugLog('üîÑ Redirecting to handle Supabase verification...');
                return; // Don't continue if we're redirecting
            }
            
            // Add small delay to show loading state
            setTimeout(() => {
                handleResetToken();
            }, 500);
        });
        
        // Handle hash changes (for single-page navigation)
        window.addEventListener('hashchange', handleResetToken);
    </script>
</body>
</html>